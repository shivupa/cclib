name: cclib

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: ['3.5', '3.6', '3.7', '3.8']
    steps:
    - name: Install swig
      run: |
        sudo apt-get update && sudo apt-get install -y -qq swig
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest numpy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Install deps Python >3.5
      if: ${{ matrix.python-version != '3.5' }}
      run: |
          #wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
          #bash miniconda.sh -b -p $HOME/miniconda -u
          #export PATH="$HOME/miniconda/bin:$PATH"
        hash -r
        $CONDA/bin/conda config --add channels conda-forge
        $CONDA/bin/conda config --add channels psi4
        $CONDA/bin/conda config --set always_yes yes --set changeps1 no --set channel_priority flexible
        $CONDA/bin/conda update -q conda
        $CONDA/bin/conda info -a
        $CONDA/bin/conda create -q -n condaenv python=${{matrix.python-version}} 
        eval "$($CONDA/bin/conda shell.bash hook)"
        $CONDA/bin/conda activate condaenv
        $CONDA/bin/conda install ci-psi4 openbabel psi4
        $CONDA/bin/conda install pytest pytest-cov codecov pytest-shutil
        python -m pip install h5py pyscf
        python -m pip install git+https://github.com/theochem/iodata.git
        $CONDA/bin/conda list
    - name: Install deps python 3.5
      if: ${{ matrix.python-version == '3.5' }}
      run: |
        sudo apt-get update && sudo apt-get -y -qq install libopenbabel-dev
        python -m pip install --global-option=build_ext --global-option='-I/usr/include/openbabel3' --global-option='-L/usr/lib/openbabel3' openbabel
        python -m pip install -U pytest pytest-cov h5py
    - name: Install cclib
      run: |
        if ${matrix.python_version} != 3.5 $CONDA/bin/conda activate condaenv
        python -m pip install .
    - name: Before Test
      run: |
        if ${matrix.python_version} != 3.5 $CONDA/bin/conda activate condaenv
        export DOCS_BRANCH_NAME=master
        export DOCS_REPO_NAME=cclib.github.io
        export DOCS_REPO_OWNER=cclib
        export DOCS_ROOT_DIR="${GITHUB_WORKSPACE}"/doc/sphinx
        export DOCS_BUILD_DIR="${DOCS_ROOT_DIR}"/_build/html
        export THEME_DIR="${DOCS_ROOT_DIR}"/_themes
        install -dm755 "${THEME_DIR}"
    - name: Test with pytest
      run: |
        if ${{ matrix.python_version }} != 3.5 $CONDA/bin/conda activate condaenv
        env | sort
        bash .github/scripts/run_pytest.bash
        bash .github/scripts/build_docs.bash
